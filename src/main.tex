%% Преамбула TeX-файла

% 1. Стиль и язык
\documentclass[utf8x, 14pt]{G7-32} % Стиль (по умолчанию будет 14pt)

% Остальные стандартные настройки убраны в preamble.inc.tex.
\include{preamble.inc}

% Стиль титульного листа и заголовки
\include{title}


\begin{document}

\frontmatter % выключает нумерацию; здесь начинаются НЕнумерованные главы: введение, глоссарий, сокращения.

\maketitle % создает титульную страницу


\begin{executors}
\personalSignature{Выполнил студент}{Щеглова П.Н.}
\end{executors}

\tableofcontents % создает содержание документа
 

\include{intro} % создает раздел Введение


\mainmatter % это включает нумерацию глав и секций в документе ниже

\chapter{Шифрование с сохранением формата}

\section{Описание концепции}
Format-preserving encryption (FPE) --- это семейство перестановок на произвольном множестве $\mathcal{S}$, индексируемое ключом $K$ \cite{ruscrypto}
$$FPE_K: \mathcal{S} \to \mathcal{S}.$$
 Примеры отображений: шифрование 16-значного номера банковской карты 16-значным числом; шифрование одного английского слова другим английским словом. Блочный шифр --- частный случай FPE--схемы, для которой  $\mathcal{S} = \{0,1\}^n$, где $n$ --- длина блока.


Истинно случайная перестановка является идеальным шифром FPE, однако для больших множеств невозможно предварительно сгенерировать и запомнить такую перестановку. Таким образом, проблема FPE состоит в том, чтобы сгенерировать псевдослучайную перестановку из секретного ключа так, чтобы время вычисления для одного значения было небольшим (в идеале постоянным, но, что наиболее важно, меньшим, чем $O(n)$, где $n$ - размер входных данных).


Алгоритм FPE можно реализовать с использованием сети Фейстеля. Например, стандарты FF1 и FF3-1 \cite{FF13-1} берут за основу алгоритма сеть Фейстеля, а в качестве раундовой функции шифрования части входных данных $F$ стандартизированный блочный шифр с блоками длины 128 бит (AES).


\section{Действующие стандарты} % Добавить ссылки на стандарты
Существует множество реализованных алгоритмов типа FPE, к действующим можно отнести разработанные в США FF1 и FF3-1 \cite{FF13-1}, а также южно-корейские FEA-1 и FEA-2 \cite{FEA}.
Алгоритм FEA, представленный институтом исследований национальной безопасности (NSR), также основан на сети Фейстеля, аналогично стандартам NIST, FF1 и FF3-1. 


Разница между FEA-1 и FEA-2 состоит в том, что FEA-1 имеет размер настройки (параметра, подающегося на вход раундовой функции $F$) $128-n$ бит (где $n$ - размер входной последовательности), каждый с 12, 14 и 16 раундами при длине двоичного ключа 128, 192 и 256 соответственно. FEA-2 имеет фиксированный размер настройки в 128 бит с 18, 21 и 24 раундами при длинах ключей 128, 192 и 256 соответственно.

\subsection{FEA-1}
Опишем подробнее стандарт, который анализируется в данной работе, а именно FEA-1:

На вход алгоритму подаются последовательности чисел из конечного множества, мощностью от $2^8$ до $2^{128}$, размер двоичного ключа $K$ может составлять 128, 192 или 256 бит. Алгоритм представляет собой последовательное применение итераций сети Фейстеля, ее общая схема представлена в левой части рисунка \ref{fig:fea_structure}. Входная последовательность $X$ на каждом раунде делится на две равные части $X_a$ и $ X_b$, $X_b$ передается на вход $F$-функции, общая схема которой обозначена в правой части рисунка \ref{fig:fea_structure}: $T_a$ и $T_b$ - левая и правая половины нстройки, принцип формирования которой будет описан далее, $RK_a$ и $RK_b$ - левая и правая половины раундового ключа, $S$ - блок подстановки (в данной схеме применяются идентичные $S$-блоки), $\mathcal{M}$ - блок умножения на заданную матрицу.

\begin{figure}[h!]
	\includegraphics[width = \textwidth]{FEA-1 structure.png}
	\caption{Структура итерации FEA, на основе сети Фейстеля}
	\label{fig:fea_structure}
\end{figure}

Выбор настройки для каждого раунда происходит по следующему алгоритму: настройка $T$ (битовый вектор длины $128-n$) делится на две под-настройки $T_L = T_{ [ 0:64-n_2-1 ] }$ и $T_R=T_{ [ 64-n_2:128-n-1 ] }$ длины $64-n_2$ и $64-n_1$, соответственно. Полагаем $T_a^i=0$ для каждой итерации и $T_b^i$ для $i$-ой итерации, как:

$$ T_b^i =
\begin{cases}
T_L & \dfrac{i}{2} \in N \\
T_R & \dfrac{i+1}{2} \in N
\end{cases} $$

\chapter{Линейный метод}

Линейный метод криптографического анализа состоит из двух этапов: 
\begin{enumerate}
    \item Нахождение линейного статистического аналога для части исходного блочного шифра. Это линейное соотношение связывает входные и выходные значения выбранной части алгоритма. Оно должно выполняться с вероятностью заметно отличающейся от случайной для возможности отличения этих двух вариантов событий.
    \item Отбрасывание ложных ключей с использованием найденного вероятностного соотношения.
\end{enumerate}

Перейдем к описанию метода:

Пусть схема шифропреобразования с ключом $K$ разбита на две последовательные части $F_{K_1}$ и $F_{K_2}$, как показано на рисунке \ref{fig:linan}. 
\begin{figure}[h!]
	\centering
	\includegraphics[scale=0.25]{linan.png}
	\caption{Схема разбиения алгоритма на два блока для проведения линейного криптографического анализа}
	\label{fig:linan}
\end{figure}
В первой из них используется часть исходного ключа $K_1$, во второй, соответсвенно, $K_2$ (при этом $K_1$ может частично совпадать с $K_2$). $c_1^{(i)}, ..., c_N^{(i)}$  - промежуточный шифртекст, между двумя блоками шифропреобразования; $b_1^{(i)}, ..., b_N^{(i)}$ - известный итоговый шифртекст, $a_1^{(i)}, ..., a_N^{(i)}$ - известный открытый текст, $i \in \overline{1,T}$, где $T$ - количество материала. Пусть также найдено линейное соотношение:

\begin{equation}
\label{eqn:eq1}
c_1^{(i)} L_1^{'} + ... + c_N^{(i)} L_N^{'} \backsimeq b_1^{(i)} L_1^{''} + ... + b_N^{(i)} L_N^{''} ,\end{equation}

 которое, \textbf{независимо от значения $K_2$}, выполняется с вероятностью $P = \dfrac{1+\delta}{2}$, где $\delta \neq 0$. Булевы величины $L_j^{'}$ и $L_s^{''}$, $j,s \in \overline{1,N}$ --- маска найденного линейного соотношения.

Пусть $K_1^{'}$ - доля ключа $K_1$, от которой зависит левая часть в соотношении \ref{eqn:eq1}. Если при опробовании $K_1^{'}$ выполнимость соотношения с вероятностью $P = \dfrac{1+\delta}{2}$ не подтверждается, то соответствующее значение $K_1^{'}$ отбраковывается. Чем больше при этом $T$ и $|\delta|$, тем большая доля значений $K_1^{'}$ будет отбракована, вплоть до однозначного определения $K_1^{'}$.

Для проверки выполнимости соотношения вычисляется оценка $\hat{\delta} = 2\cdot\dfrac{\sum_{i=1}^T \left(c_1^{(i)} L_1^{'} + ... + c_N^{(i)} L_N^{'} == b_1^{(i)} L_1^{''} + ... + b_N^{(i)} L_N^{''}\right)} {T} - 1 $, где функция под знаком суммы принимает значение 1 при равенстве левой и правой частей, что означает выполнение линейного соотношения для данной пары открытого и шифрованного текстов, и 0 при неравенстве.

Для того, чтобы применить вычисляемую оценку для отбраковывания ложных ключей, необходим различитель, который на основе теоритической $\delta$ определяет выполнилось ли соотношение с нужной вероятностью. Чтобы построить различитель, воспользуемся результатами, полученными в \cite{main_paper}.


\section{Теоритические выкладки из \cite{main_paper}}
Пусть $F: \mathbb{F}_2^n \to \mathbb{F}_2^n$ - наша раундовая функция, $n$ - размер блока. Различитель строится на основе линейных соотношений с большой $\delta$. Линейное соотношение для $F$ определяется двумя масками $(L^{'}, L^{''}) \in \mathbb{F}_2^n \oplus \mathbb{F}_2^n$, и их $\delta$ равна:
$$ \delta_{L^{'}, L^{''}}^{F} = 2\cdot P\left(L^{'} \& F(x) = L^{''} \& x\right)-1 ,$$
где вероятность считается от равномерно распределенного открытого текста  $x\in \mathbb{F}_2^n$, а \& означает побитовое наложение маски на текст. Если $L^{'} \neq 0$, то математическое ожидание $\delta$ равновероятно распределенной функции равно нулю, а стандартное отклонение $\sigma = 2^{-n/2}$. Следовательно, если $\hat{\delta}$ значительно превосходит $2^{-n/2}$, то различителем можно считать вычисление $\hat{\delta}$ для возможных пар масок и сравнение получившего значения с некоторым заданным пороговым значением.

Основное наблюдение \cite{main_paper}, которое можно эксплуатировать в атаках на FPE шифры, состоит в том, что шифр оказывается нестойким, если настройка (её часть) считается частью входных данных.


Рассмотрим два раунда FEA-1 (рисунок \ref{fig:trial}), настройка $T_L$ - произвольная постоянная, а $T_R$ считается переменной входа. Если это не так, то для проведения атаки $T_R$ должна быть известной. Идея атаки состоит в том, что $\delta$  линейного соотношения раундовой функции $F_r$ превышает $ 2^{-n/2}$ с достаточно большой вероятностью, что важно, когда настройка включается во входные данные, потому что область определения функции, которая отображает настройку и открытый текст в шифртекст, велика. Математическое ожидание $\delta$ линейных соотношений над случайной функцией с тем же размером входа (включая $T_R$ размера $64-n_1$), что и в FEA-1, равно нулю, а стандартное отклонение $2^{-32-n_1/2}$. 

\begin{figure}[h!]
	\centering
	\includegraphics[scale=0.5]{trial.png}
	\caption{Две итерации FEA-1}
	\label{fig:trial}
\end{figure}

\subsection{Теорема}\label{theorem}

 Пусть получена $\delta$ для некоторого линейного соотношения равномерно распределенной функции $F: \mathbb{F}_2^n \to \mathbb{F}_2^n$. Случайная величина $2^{n-1}(\delta+1)$ имеет биномиальное распределение с математическим ожиданием $2^{n-1}$ и дисперсией $2^{n-2}$. В частности, при $n\to\infty$ распределение $2^{n/2}\delta$ сходится к стандартному нормальному распределению $\mathcal{N}(0,1)$.

\subsection{Применение}

Пусть $r\geq 2$ - четное целое число. $\delta$ для $r$ раундов равна $\delta=\prod_{i=1}^{r/2} \delta_i$, где $\delta_i \thicksim \mathcal{N}(0,1/\sqrt{N})$ по теореме \ref{theorem}, $N$ --- мощность множества текстов. Переменнные $\delta_i$ будем считать независимыми, что следует из предположения о независимости раундовых функций $F_1, F_3, ..., F_{r-1}$.

Эвристически вычислимо, что для FEA-1
\begin{equation}
\label{eqn:keyeq}
1/\mathbb{E}(\delta^2)=\sqrt{N}^{r/2},\end{equation} 
где $\mathbb{E}(\delta^2)$ - средне-квадратичная $\delta$ для равномерно распределенного случайного ключа.


\chapter{Эксперимент}
Теперь проведем эксперимент: возьмем все возможные тексты размера 8 бит, сгенерируем произвольный ключ длины 128 бит, зафиксируем произвольной константой первую часть настройки и будем проведить шифрование алгоритмом FEA-1 всего в два раунда. Зафиксируем число $\alpha \in \overline{1,15}$ и зададим две маски: $\alpha|0$ и $0|\alpha$. Для каждой второй части настройки сгенерированной произвольно 1000 раз, для каждого открытого текста из множества производим зашифрование, с помощью полученного шифртекста получаем квадрат оценки $\hat{\delta}$ для первой маски (и на входе, и на выходе маска берется одна и та же) и квадрат оценки для второй маски, усредняем оценки по всем настройкам. 

$1/\mathbb{E}(\delta^2)=\sqrt{N}^{r/2} = (2^4)^{2/2} = 2^4, \mathbb{E}(\delta^2) = 0.0625$

Результаты эксперимента можно найти по \href{https://github.com/jerrydie/course_work}{ссылке}.

\section{Выводы}
В результате эксперимента предполагалось получить для каждого $\alpha \in \overline{1,15}$ сильно различающиеся значения для двух разных масок, однако этого не произошло, и разброс значений оказался довольно большим. Из чего можно сделать вывод, что доверять чужим реализациям шифропреобразований не стоит, и необходимо повторить эксперимент для созданной с нуля реализации алгоритма.
% \cite{hse:Teoria_Gener} любой характеристический многочлен ЛРП кратен минимальному многочлену. Тогда достаточно проверить делители характеристической функции.





\backmatter %% Здесь заканчивается нумерованная часть документа и начинаются ссылки

\include{biblio}


%\appendix   % Тут идут приложения

%\include{90-appendix1}

%\include{91-appendix2}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
